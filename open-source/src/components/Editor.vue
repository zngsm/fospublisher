<template>
  <body style="width: 1000px;">
  <div class="d-flex flex-wrap align-center">
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('bold')">
          <i class="fas fa-bold"></i>
        </v-btn>
      </template>
      <span>êµµê²Œ</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('italic')">
          <i class="fas fa-italic"></i>
        </v-btn>
      </template>
      <span>ê¸°ìš¸ì„ê¼´</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('underline')">
          <i class="fas fa-underline"></i>
        </v-btn>
      </template>
      <span>ë°‘ì¤„</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('strikethrough')">
          <i class="fas fa-strikethrough"></i>
        </v-btn>
      </template>
      <span>ì·¨ì†Œì„ </span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('justifyLeft')">
          <i class="fas fa-align-left"></i>
        </v-btn>
      </template>
      <span>ì™¼ìª½ ì •ë ¬</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('justifyCenter')">
          <i class="fas fa-align-center"></i>
        </v-btn>
      </template>
      <span>ê°€ìš´ë° ì •ë ¬</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('justifyRight')">
          <i class="fas fa-align-right"></i>
        </v-btn>
      </template>
      <span>ì˜¤ë¥¸ìª½ ì •ë ¬</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('justifyFull')">
          <i class="fas fa-align-justify"></i>
        </v-btn>
      </template>
      <span>ì–‘ìª½ ë§ì¶¤</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('cut')">
          <i class="fas fa-cut"></i>
        </v-btn>
      </template>
      <span>ì˜ë¼ë‚´ê¸°</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('copy')">
          <i class="fas fa-copy"></i>
        </v-btn>
      </template>
      <span>ë³µì‚¬í•˜ê¸°</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('indent')">
          <i class="fas fa-indent"></i>
        </v-btn>
      </template>
      <span>ë“¤ì—¬ì“°ê¸°</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('outdent')">
          <i class="fas fa-outdent"></i>
        </v-btn>
      </template>
      <span>ë‚´ì–´ì“°ê¸°</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('subscript')">
          <i class="fas fa-subscript"></i>
        </v-btn>
      </template>
      <span>ì•„ë˜ ì²¨ì</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('superscript')">
          <i class="fas fa-superscript"></i>
        </v-btn>
      </template>
      <span>ìœ„ ì²¨ì</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('undo')">
          <i class="fas fa-undo"></i>
        </v-btn>
      </template>
      <span>ì·¨ì†Œ</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('redo')">
          <i class="fas fa-redo"></i>
        </v-btn>
      </template>
      <span>ë‹¤ì‹œ ì‹¤í–‰</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('insertUnorderedList')">
          <i class="fas fa-list-ul"></i>
        </v-btn>
      </template>
      <span>ê¸€ë¨¸ë¦¬ ê¸°í˜¸</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('insertOrderedList')">
          <i class="fas fa-list-ol"></i>
        </v-btn>
      </template>
      <span>ë²ˆí˜¸ ë§¤ê¸°ê¸°</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('insertParagraph')">
          <i class="fas fa-paragraph"></i>
        </v-btn>
      </template>
      <span>ì¤„ë°”ê¿ˆ</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile fab small v-bind="attrs" v-on="on" @click="execCmd('insertHorizontalRule')">
          HR
        </v-btn>
      </template>
      <span>ê°€ë¡œì„ </span>
    </v-tooltip>
    
    <v-tooltip bottom>
    <template v-slot:activator="{ on, attrs }">
        <v-btn
          text 
          tile 
          fab 
          small
          v-bind="attrs"
          v-on="on"
          @click="linkModal = true"
        >
          <i class="fas fa-link"></i>
        </v-btn>
      </template>
      <span>ë§í¬</span>
    </v-tooltip>
    <v-dialog
      v-model="linkModal"
      width="500"
    >
      <v-card>
        <v-card-title class="headline">
          Link
        </v-card-title>

        <v-text-field
          class="mx-4 my-5"
          v-model="pageLink"
          label="Insert link"
          outlined
          dense
          clearable
        ></v-text-field>

        <v-divider></v-divider>

        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn
            color="primary"
            @click="inserLink"
          >
            okay
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn
          id="emoji-trigger" 
          text 
          tile 
          small 
          v-bind="attrs"
          v-on="on"
          class="py-5 px-0" 
        >
          <h2>ğŸ˜€</h2>
        </v-btn>
      </template>
      <span>ì´ëª¨í‹°ì½˜</span>
    </v-tooltip>
    
    <div class="text-center">
      <v-menu offset-y>
        <template v-slot:activator="{ on: onMenu }">
          <v-tooltip bottom>
            <template v-slot:activator="{ on: onTooltip }">
              <v-btn
                text 
                tile 
                small 
                class="py-5" 
                v-on="{ ...onMenu, ...onTooltip }"
              >
                Font Style â–¾
              </v-btn>
            </template>
            <span>ê¸€ê¼´</span>
          </v-tooltip>
        </template>
        <v-list>
          <v-list-item
            v-for="(item, index) in fontStyle"
            :key="index"
            link
          >
            <v-list-item-title @click="execCommandWithArg('fontName', item)" :style="{ 'font-family': [item]}">{{ item }}</v-list-item-title>
          </v-list-item>
        </v-list>
      </v-menu>
    </div>

    <div class="text-center">
      <v-menu offset-y :close-on-click="true">
        <template v-slot:activator="{ on: onMenu }">
          <v-tooltip bottom>
            <template v-slot:activator="{ on: onTooltip }">
              <v-btn
                text 
                tile 
                small 
                class="py-5" 
                v-on="{ ...onMenu, ...onTooltip }"
              >
                Font size â–¾
              </v-btn>
            </template>
            <span>ê¸€ê¼´ í¬ê¸°</span>
          </v-tooltip>
        </template>
        <v-list>
          <v-list-item
            v-for="(item, index) in fontSize"
            :key="index"
            link
          >
            <v-list-item-title @click="execCommandWithArg('formatBlock', item)">{{ item }}</v-list-item-title>
          </v-list-item>
        </v-list>
      </v-menu>
    </div>

    <v-btn text tile small class="py-5" disabled >Font Color</v-btn>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <input v-bind="attrs" v-on="on" style="cursor: pointer" type="color" @change="execCommandWithArg('foreColor', $event.target.value);"/>
      </template>
      <span>ê¸€ê¼´ ìƒ‰</span>
    </v-tooltip>
    <v-btn text tile small class="py-5" disabled >Background Color </v-btn>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <input v-bind="attrs" v-on="on" style="cursor: pointer" type="color" @change="execCommandWithArg('hiliteColor', $event.target.value);"/>
      </template>
      <span>í…ìŠ¤íŠ¸ ê°•ì¡° ìƒ‰</span>
    </v-tooltip>
    
    <v-dialog
      v-model="imageModal"
      width="500"
    >
    <template v-slot:activator="{ on: onModal }">
      <v-tooltip bottom>
        <template v-slot:activator="{ on: onTooltip }">
        <v-btn
          text 
          tile 
          small
          v-on="{ ...onModal, ...onTooltip }"
          class="py-5"
        >
          <i class="fas fa-file-image pr-1"></i>image
        </v-btn>
      </template>
      <span>ì´ë¯¸ì§€ ì‚½ì…</span>
      </v-tooltip>
    </template>

      <v-card>
        <v-card-title class="headline">
          Image upload
        </v-card-title>

        <v-file-input
          class="mx-4 mt-5"
          v-model="imageFile"
          label="File input"
          outlined
          dense
        ></v-file-input>
        <v-text-field
          class="mx-4"
          v-model="imageLink"
          label="Image link"
          outlined
          dense
          clearable
        ></v-text-field>

        <v-divider></v-divider>

        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn
            color="primary"
            @click="insertImage"
          >
            Okay
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile small v-bind="attrs" v-on="on" class="py-5" @click="execCmd('selectAll')">
          Select All
        </v-btn>
      </template>
      <span>ì „ë¶€ ì„ íƒ</span>
    </v-tooltip>
    <v-tooltip bottom>
      <template v-slot:activator="{ on, attrs }">
        <v-btn text tile small v-bind="attrs" v-on="on" class="py-5" @click="exportToPDF()">
          <i class="fas fa-file-pdf pr-1"></i>PDF
        </v-btn>
      </template>
      <span>PDF ì¶”ì¶œ</span>
    </v-tooltip>
  </div>

  <iframe name="richTextField" style="width: 1000px; height: 500px; border: solid #D1D1D1 1px; border-radius: 3px;"></iframe>
  </body>
</template>

<script>
import { EmojiButton } from '@joeattardi/emoji-button';
import html2pdf from 'html2pdf.js'
import $ from 'jquery'
require('jquery');
require('jquery-ui-bundle');

export default {
  data() {
    return {
      isInEditMode: true,
      fontSize: ['H1', 'H2', 'H3', 'H4', 'H5', 'H6'],
      fontStyle: ['ë‹ì›€', 'êµ´ë¦¼', 'ë°”íƒ•','ê¶ì„œ', 'ë§‘ì€ ê³ ë”•'],
      // fontStyle: ['Arial', 'Comic Sans MS', 'Courier', 'Georgia', 'Tahoma', 'Times New Roman', 'Verdana'],
      imageModal: false,
      imageFile: [],
      imageLink: '',
      imageNum: 0,
      linkModal: false,
      pageLink: '',
    }
  },
  methods: {
    // ì´ë¯¸ì§€ ì‚½ì… í›„ ë“œë˜ê·¸ ë° ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì¶”ê°€ í•¨ìˆ˜
    imageDragResize() {
      const vm = this
      $('iframe[name="richTextField"]').contents().find(`#${vm.imageNum}`).wrap(`<div id="draggableHelper${vm.imageNum}" contenteditable="false" style="display:inline-block"></div>`)
      // ì´ë¯¸ì§€ ìœ„ ì•„ë˜ë¡œ ë¹ˆ ì¹¸ ì¶”ê°€
      $('iframe[name="richTextField"]').contents().find(`#draggableHelper${vm.imageNum}`).after('<br>');
      $('iframe[name="richTextField"]').contents().find(`#draggableHelper${vm.imageNum}`).before('<br>');
      
      // xì¶• ë°©í–¥ìœ¼ë¡œë§Œ ì´ë¯¸ì§€ ë“œë˜ê·¸ ê°€ëŠ¥, richtextField ë‚´ì—ì„œë§Œ ì›€ì§ì¼ ìˆ˜ ìˆìŒ
      $('iframe[name="richTextField"]').contents().find(`#draggableHelper${vm.imageNum}`).draggable({
        containment: window.richTextField.document.getElementsByTagName('body'), 
        axis: "x"
      })

      // ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ë§ ì ìš©(iframì€ cssì§ì ‘ì ìœ¼ë¡œ ìˆ˜ì • ë¶ˆê°€)
      // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ëŸ¬ css 
      $('iframe[name="richTextField"]').contents().find(`#${vm.imageNum}`).resizable({aspectRatio: true, minWidth: 300 })
      $('iframe[name="richTextField"]').contents().find(`#draggableHelper${vm.imageNum} > .ui-wrapper`).children('.ui-resizable-handle').css({
        'position': 'absolute',
        'font-size': '0.1px',
        'display': 'block',
        '-ms-touch-action': 'none',
        'touch-action': 'none'})
      $('iframe[name="richTextField"]').contents().find(`#draggableHelper${vm.imageNum} > .ui-wrapper`).children('.ui-resizable-e').css({
        'cursor': 'e-resize',
        'width': '7px',
        'right': '-5px',
        'top': '0',
        'height': '100%'})
      $('iframe[name="richTextField"]').contents().find(`#draggableHelper${vm.imageNum} > .ui-wrapper`).children('.ui-resizable-s').css({
        'cursor': 's-resize',
        'height': '7px',
        'bottom': '-5px',
        'left': '0',
        'width': '100%'})
      $('iframe[name="richTextField"]').contents().find(`#draggableHelper${vm.imageNum} > .ui-wrapper`).children('.ui-resizable-se').css({
        'cursor': 'se-resize',
        'height': '12px',
        'bottom': '1px',
        'right': '1px',
        'width': '12px'})
      $('iframe[name="richTextField"]').contents().find(`#${vm.imageNum}`).mouseenter(function(event) {
            event.target.style.cursor = 'pointer'
            event.target.style.border = 'solid white 3px'
            event.target.style.boxSizing = 'border-box'
      });
      $('iframe[name="richTextField"]').contents().find(`#${vm.imageNum}`).mouseout(function(event) {
          event.target.style.border = 'none'
      });
      vm.imageNum += 1
    },
    inserLink() {
      this.linkModal = false
      if (this.pageLink != '') {
        this.execCommandWithArg('createLink', this.pageLink)
        const links = window.richTextField.document.querySelectorAll('a')
        links.forEach(item => {
          item.target = '_blank';
          // ë§í¬ ì‚½ì… í›„ í´ë¦­í•˜ë©´ ë§í¬ë¡œ ì´ë™í•  ìˆ˜ ìˆë„ë¡ ë””ìì¸ ëª¨ë“œ ë”
          item.addEventListener('mouseover', () => {
            window.richTextField.document.designMode = 'Off'
          });
          // ë§í¬ ì‚½ì… í›„ ë‹¤ë¥¸ ì‘ì—…ì´ ê°€ëŠ¥í•˜ë„ë¡ ë””ìì¸ ëª¨ë“œ ë‹¤ì‹œ í‚´ 
          item.addEventListener('mouseout', () => {
            window.richTextField.document.designMode = 'On'
          });
        })
        this.pageLink = ''
      }
    },
    insertImage() {
      this.imageModal = false
      // ë¡œì»¬ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ì˜¬ë¦¬ëŠ” ê²½ìš°
      if (this.imageFile.length != 0) {
        var file = this.imageFile
        var reader = new FileReader();
        var image = new Image();
        var vm = this
        reader.onloadend = function() {
          image.src = reader.result
          window.richTextField.document.getElementsByTagName('body')[0].appendChild(image)
          image.style.maxWidth = '100%'
          // ì´ë¯¸ì§€ë§ˆë‹¤ ê°œë³„ idë¥¼ ë¶€ì—¬í•¨ìœ¼ë¡œì¨ imageDragResize í•¨ìˆ˜ì—ì„œ ì´ë¯¸ ê¸°ëŠ¥ì´ ì ìš©ëœ ì´ë¯¸ì§€ì—ëŠ” ì¶”ê°€ë¡œ ì‘ë™í•˜ì§€ ì•Šë„ë¡ ì¡°ì •
          image.setAttribute('id', vm.imageNum)
          image.onload = function() {
            // ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ê³  ì•„ë˜ í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ë„ë¡ onload ëª…ë ¹ì–´ ì‚¬ìš©
            vm.imageDragResize()
          }
        }
        reader.readAsDataURL(file);
        // ë¬¸ì œì : í˜„ì¬ ê°™ì€ ì´ë¯¸ì§€ë¥¼ ë‘ ë²ˆ ì˜¬ë¦´ ìˆ˜ ì—†ìŒ 
        // ì°¾ì•„ë³´ë‹ˆ vuetify ìì²´ì ì¸ ì˜¤ë¥˜ì¸ë“¯í•¨...ì¶”í›„ ìˆ˜ì • í•„ìš”
        this.imageFile = []

        // ì´ë¯¸ì§€ ë§í¬ë¡œ ì˜¬ë¦¬ëŠ” ê²½ìš°
      } else if (this.imageLink != '') {
        this.execCommandWithArg('insertImage', this.imageLink)
        const vm = this
        const imgTags = $('iframe[name="richTextField"]').contents().find('img')
        imgTags.each(function (index, imgTag) {
          if (imgTag.id == '') {
            imgTag.setAttribute('id', vm.imageNum)
            imgTag.style.maxWidth = '100%'
            imgTag.onload = function() {
              vm.imageDragResize()
            }
          }
        })
        this.imageLink = ''
      }
    },
    execCmd(command) {
      // ì¸ìê°€ í•„ìš”ì—†ëŠ” ëª…ë ¹ì–´ì¸ ê²½ìš°
      // ex. ê¸€ì”¨ êµµê²Œ í•˜ê¸°, ê°€ë¡œì„  ë„£ê¸° ë“±
      window.richTextField.document.execCommand(command, false, null);
    },
    execCommandWithArg(command, arg) {
      // ì¸ìê°€ í•„ìš”í•œ ëª…ë ¹ì–´ì¸ ê²½ìš°
      // ex. ì´ë¯¸ì§€ ì‚½ì…ì‹œ ë§í¬
      window.richTextField.document.execCommand(command, false, arg);
    },
 
    exportToPDF() {
      // html2pdf npm ëª¨ë“ˆ ì‚¬ìš©
      html2pdf(window.richTextField.document.getElementsByTagName('body')[0], {
        margin: 0,
        filename: 'document.pdf',
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { width: 976, height: 1600 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      })
      
      // .from(element).set({
      //   pagebreak: { mode: 'avoid-all', after: '#root' },
      // })

    },
  },
  mounted() {
    // richTextFieldì˜ ë‚´ìš©ì„ ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡ ë””ìì¸ ëª¨ë“œë¥¼ ì¼œì¤Œ
    window.richTextField.document.designMode = 'On'

    // ë¬¸ìê°€ richTextFieldì˜ ë„ˆë¹„ë¥¼ ë„˜ì–´ì„°ì„ ë•Œ ìë™ìœ¼ë¡œ ì¤„ë°”ê¿ˆ
    window.richTextField.document.getElementsByTagName('body')[0].style.wordBreak = "break-all"

    // ì´ëª¨í‹°ì½˜ ì„ íƒí•˜ë©´ ì»¤ì„œ ìœ„ì¹˜ì— ì‚½ì…í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ì½”ë“œ
    const picker = new EmojiButton();
    const trigger = document.querySelector('#emoji-trigger');
    picker.on('emoji', selection => {
      this.execCommandWithArg('insertHTML', selection.emoji);
    });

    trigger.addEventListener('click', () => picker.togglePicker(trigger));
  },
}
</script>

<style scoped>
.v-text-field__details {
  display: none !important;
}
</style>
